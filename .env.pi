# =============================================================================
# SecureClaw Raspberry Pi Configuration
# =============================================================================
# Optimized for Raspberry Pi 4GB RAM
# Target: <500MB memory usage under load
# =============================================================================

# -----------------------------------------------------------------------------
# Node.js Memory Limits
# -----------------------------------------------------------------------------
# Restrict heap to 450MB (leaves 550MB for OS + buffers on 1GB available)
# Use smaller semi-space for faster minor GC cycles
NODE_OPTIONS="--max-old-space-size=450 --max-semi-space-size=16"

# Optional: Enable GC profiling for debugging
# NODE_OPTIONS="--max-old-space-size=450 --max-semi-space-size=16 --expose-gc"

# -----------------------------------------------------------------------------
# Memory Manager (SQLite + Embeddings)
# -----------------------------------------------------------------------------
# Limit embedding cache to ~50MB (5000 entries Ã— ~10KB each)
SECURECLAW_MEMORY_CACHE_MAX_ENTRIES=5000

# Smaller batch sizes to reduce peak memory
SECURECLAW_MEMORY_SYNC_BATCH_SIZE=50

# Explicit cache size limit in MB
SECURECLAW_EMBEDDING_CACHE_MAX_MB=50

# Disable file watching (uses inotify handles)
SECURECLAW_MEMORY_SYNC_WATCH=false

# Less frequent interval syncs (every 30 minutes instead of 15)
SECURECLAW_MEMORY_SYNC_INTERVAL_MINUTES=30

# -----------------------------------------------------------------------------
# Session Manager Cache
# -----------------------------------------------------------------------------
# Default 45 seconds is good - short enough to not accumulate
SECURECLAW_SESSION_MANAGER_CACHE_TTL_MS=45000

# Disable session preloading (loads files lazily instead)
SECURECLAW_SESSION_PRELOAD_ENABLED=false

# -----------------------------------------------------------------------------
# Security Coach LLM Cache
# -----------------------------------------------------------------------------
# Limit LLM judge cache to 1000 entries (~1-2MB)
SECURECLAW_SECURITY_COACH_LLM_CACHE_MAX_ENTRIES=1000

# Cache TTL: 1 hour (balance between hits and memory)
SECURECLAW_SECURITY_COACH_LLM_CACHE_TTL_MS=3600000

# Allow longer LLM latency on Pi (2 seconds instead of 1)
SECURECLAW_SECURITY_COACH_LLM_MAX_LATENCY_MS=2000

# -----------------------------------------------------------------------------
# WebSocket Connection Pool
# -----------------------------------------------------------------------------
# Limit to 20 concurrent connections (instead of unlimited)
SECURECLAW_WS_MAX_CONNECTIONS=20

# Close idle connections after 5 minutes
SECURECLAW_WS_IDLE_TIMEOUT_MS=300000

# Smaller max payload (16MB instead of 100MB)
SECURECLAW_WS_MAX_PAYLOAD_MB=16

# -----------------------------------------------------------------------------
# Memory Monitoring
# -----------------------------------------------------------------------------
# Enable memory monitor (triggers cleanup at 80% of 450MB = 360MB)
SECURECLAW_MEMORY_MONITOR_ENABLED=true

# Max heap before warnings (should match NODE_OPTIONS)
SECURECLAW_MEMORY_MAX_HEAP_MB=450

# Warning threshold: 80% of max heap
SECURECLAW_MEMORY_WARNING_THRESHOLD_PCT=80

# Check interval: every 30 seconds
SECURECLAW_MEMORY_CHECK_INTERVAL_MS=30000

# -----------------------------------------------------------------------------
# Gateway Configuration
# -----------------------------------------------------------------------------
# Smaller message buffer (1000 instead of 10000)
SECURECLAW_GATEWAY_MESSAGE_BUFFER_SIZE=1000

# Shorter buffer retention (5 minutes instead of 30)
SECURECLAW_GATEWAY_MESSAGE_BUFFER_TTL_MS=300000

# -----------------------------------------------------------------------------
# Agent Configuration
# -----------------------------------------------------------------------------
# Disable expensive features on Pi
SECURECLAW_AGENT_THINKING_ENABLED=false
SECURECLAW_AGENT_VOICE_ENABLED=false

# Smaller context window (100K instead of 200K)
SECURECLAW_AGENT_MAX_CONTEXT_TOKENS=100000

# -----------------------------------------------------------------------------
# Media Processing
# -----------------------------------------------------------------------------
# Reduce image quality to save memory
SECURECLAW_MEDIA_IMAGE_MAX_WIDTH=1920
SECURECLAW_MEDIA_IMAGE_MAX_HEIGHT=1080
SECURECLAW_MEDIA_IMAGE_QUALITY=80

# Disable video processing (too memory-intensive for Pi)
SECURECLAW_MEDIA_VIDEO_ENABLED=false

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
# Reduce log retention to save disk space
SECURECLAW_LOG_MAX_FILES=7
SECURECLAW_LOG_MAX_SIZE_MB=50

# Disable debug logging in production
SECURECLAW_LOG_LEVEL=info

# -----------------------------------------------------------------------------
# Database (SQLite)
# -----------------------------------------------------------------------------
# Use WAL mode for better concurrency with lower memory
SECURECLAW_SQLITE_WAL_MODE=true

# Smaller cache size (2MB instead of 8MB)
SECURECLAW_SQLITE_CACHE_SIZE=-2000

# Disable mmap (saves memory but slower I/O)
SECURECLAW_SQLITE_MMAP_SIZE=0

# -----------------------------------------------------------------------------
# Optional: Swap Configuration
# -----------------------------------------------------------------------------
# If you have swap enabled, allow Node.js to use it as emergency overflow
# (Not recommended for production, but acceptable for dev/testing on Pi)
# NODE_OPTIONS="${NODE_OPTIONS} --allow-os-swap"
